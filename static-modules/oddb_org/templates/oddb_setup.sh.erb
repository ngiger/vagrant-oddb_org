#!/bin/bash 
# Modified by Niklaus Giger, 2013-04-04
export ODDB_HOME=<%= foostatus = scope.lookupvar('ODDB_HOME') %>
cd $ODDB_HOME/doc/resources
wget http://download.dojotoolkit.org/release-1.3.0/dojo-release-1.3.0.tar.gz
if [ $? -ne 0 ] ; then exit 1; fi
tar -zxf dojo-release-1.3.0.tar.gz && mv dojo-release-1.3.0 dojo
if [ $? -ne 0 ] ; then exit 1; fi
cd $ODDB_HOME
pwd
cp .git/refs/heads/master .git/ORIG_HEAD
# cp -r /home/vagrant/oddb_setup/captcha data
ruby19 bin/update_css

# Here we compile some helper methods using ruby18, even when we
# will use them afterwards with ruby19
# Niklaus just does not want to patch too much!
ruby18 -v
gem18 list -i racc;  if [ $? -ne 0 ] ; then gem18 install racc; fi
gem18 list racc
cd data
mkdir -p pdf
cd quanty
pwd
ruby18 extconf.rb
if [ $? -ne 0 ] ; then exit 1; fi
src=parse.y
dst=lib/quanty/parse.rb
tmp=lib/quanty/parse.backup
rm -f $dst
mkdir -p `dirname $dst`
ruby18 /usr/bin/racc -E -o $dst $src
if [ $? -ne 0 ] ; then exit 1; fi
mv $dst $tmp
echo '# encoding: utf-8'  > $dst
cat $tmp >> $dst
pwd
make
if [ $? -ne 0 ] ; then exit 1; fi
make install
if [ $? -ne 0 ] ; then exit 1; fi
