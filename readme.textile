h1. Eays setup to ODDB.org

Goal: "Setup":http://dev.ywesee.com/Choddb/SetupOddborg#StartHere of oddb.org should be easy and automatated.

As creating funtoo using veewee failed. I downloaded and used then preconfigured "Vagrant box":http://ftp.heanet.ie/mirrors/funtoo/funtoo-current/vagrant/x86-64bit/vagrant-generic_64-funtoo-current-2012-01-26.box

After a @vagrant up@ I remarked, that it was not fully vagrant compatible. Therefore I used the following commands from @funtoo-latest-x86_64/postinstall.sh@ to import all

bc. emerge app-emulation/virtualbox-guest-additions
# we need this as gentoo doesn't do it on its own
groupadd -r vboxsf
mkdir /media && chgrp vboxsf /media
rc-update add virtualbox-guest-additions default

Then after a reboot vagrant still says, that the virtualbox additions are not installed. As I have no time to follow the "instructions for Virtualbox_Guest":http://en.gentoo-wiki.com/wiki/Virtualbox_Guest.

This means that the command on my dev machine @vagrant provision@ does not work.
I decided to run puppet directly on the VM. To achieve this the following cmds were run:

@sudo mv /etc/puppet /etc/puppet.orig@
@sudo checkout git://github.com/ngiger/vagrant-oddb_org.git /etc/puppet@

Now I want to be able to run puppet manifests as root with puppet 3.1 and ruby 1.9.2 as default. 

@sudo -i rvm --default ruby-1.9.2-p290@
@sudo -i rvm get stable@

Then modified /etc/env.d/10rubygems to get rid of RUBYOPTS with -rauto_gem. I use rvm.

@sudo -i gem install bundler@
@sudo -iH bundle install --gemfile /etc/puppet/Gemfile@

The command above only completed after uncommented the "@ruby-libvirt@" gem in the Gemfile.

Now my first (very simple) notify.pp manifest worked correctly as shown below:

bc. vagrant@localhost ~ $ cat /etc/puppet/manifests/notify.pp
notify { "site.pp": }
vagrant@localhost ~ $ sudo puppet apply /etc/puppet/manifests/notify.pp
warning: Could not retrieve fact fqdn
notice: site.pp
notice: /Stage[main]//Notify[site.pp]/message: defined 'message' as 'site.pp'
notice: Finished catalog run in 0.01 seconds
 
Next step is to make hiera work.

bc. sudo -i hiera xx
Failed to start Hiera: RuntimeError: Config file /etc/hiera.yaml not found
vagrant@localhost /etc/puppet $ sudo ln -s /etc/puppet/hiera.yaml  /etc/
vagrant@localhost /etc/puppet $ hiera --debug xxx
DEBUG: 2013-03-25 14:27:34 -0700: Hiera YAML backend starting
DEBUG: 2013-03-25 14:27:34 -0700: Looking up xxx in YAML backend
DEBUG: 2013-03-25 14:27:34 -0700: Looking for data source private/config
DEBUG: 2013-03-25 14:27:34 -0700: Cannot find datafile /etc/puppet/private/config.yaml, skipping
DEBUG: 2013-03-25 14:27:34 -0700: Looking for data source hieradata/common
DEBUG: 2013-03-25 14:27:34 -0700: Found xxx in hieradata/common
Default config value for variable xxx
date is Mon Mar 25 14:28:12 PDT 2013

Copied my .ssh/keys to be able to push into my github project. date and ssh-add don't work correctly neither!
Pushed work to github. (commit "hiera works now correctly")

Create a sshfs to exchange my files.
@/usr/bin/sshfs -p 22022 -o reconnect -o follow_symlinks vagrant@localhost:/ /mnt/oddb_org@


h2. Following the script

References /var/www -> assume that I need an apache installation -> use a puppet module to install Apache ->

@puppet module install puppetlabs/apache --modulepath /etc/puppet/modules/@

To ensure that apache is always running added @service{ 'apache2': ensure => running}@.

I want to start my own module, too.

@puppet module generate ngiger-oddb_org  --modulepath /etc/puppet/modules/@

Create new files @modules/ngiger-oddb_org/init.pp@ and adapted files to make
@sudo -i puppet apply /etc/puppet/modules/ngiger-oddb_org/tests/init.pp --modulepath /etc/puppet/modules/@ run.

But it seems that puppetlabs does not know too much about Gentoo, neither less about  Funtooo

bc. sudo -i puppet apply /etc/puppet/modules/oddb_org/tests/init.pp --modulepath /etc/puppet/modules/
Warning: Could not retrieve fact fqdn
Error: Class['apache::params']: Unsupported operatingsystem: Gentoo at /etc/puppet/modules/apache/manifests/params.pp:93 on node localhost
Error: Class['apache::params']: Unsupported operatingsystem: Gentoo at /etc/puppet/modules/apache/manifests/params.pp:93 on node localhost
vagrant@localhost /etc/puppet $ 

But using @package{ 'apache': }@ works.

Now use vcsrepo to setup the git clone
@puppet module install --modulepath /etc/puppet/modules/ puppetlabs-vcsrepo@

Added files for oddb_org/oddb_git class and tests. I have problems running them as I get the following errors:

bc. Error: Execution of '/usr/bin/git clone git://scm.ywesee.com/oddb.org/.git  /home/vagrant/oddb.org' returned 128: fatal: remote error: access denied or repository not exported: /oddb.org/.git 
Cloning into '/home/vagrant/oddb.org'...

Running the same command by hand was successfull:

bc. usr/bin/git clone git://scm.ywesee.com/oddb.org/.git  /home/vagrant/oddb.org; res=$?; echo result of git was $res
Cloning into '/home/vagrant/oddb.org'...
remote: Counting objects: 37264, done.
remote: Compressing objects: 100% (13388/13388), done.
remote: Total 37264 (delta 29285), reused 30058 (delta 23513)
Receiving objects: 100% (37264/37264), 18.12 MiB | 2.94 MiB/s, done.
Resolving deltas: 100% (29285/29285), done.
result of git was 0

What can the problem be? I have puppet 2.7 via emerge and puppet 3.1.1 via gem. Decided to manually run the command and proceed to the next step.


h1. Unsuccessfull tries to build a basebox using veewee

Benutze Ruby 1.9.2p320 (ich wusste, dass damit gentoo lÃ¤uft)

bc. git clone git://github.com/ngiger/vagrant-oddb_org.git
git clone git://github.com/jedi4ever/veewee.git
cd veewee
bundle install
vagrant basebox define funtoo-latest-x86_64 funtoo-latest-x86_64
# lokale Modifikationen von mir in definitions/funtoo-latest-x86_64
# damit es hochkommt
vagrant basebox build funtoo-latest-x86_64
# Das dauert ca 35 Minuten mit 4 CPU & 4 GB lange. Kompiliert 3.8.4-gentoo for x86_64
vagrant basebox export funtoo-latest-x86_64
ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 7222 -l root 127.0.0.1 # Zum Testen ob alles gut lief
vagrant box add funtoo-latest-x86_64 funtoo-latest-x86_64.box
cd ..
vagrant init funtoo-latest-latest-x86_64
vagrant up
vagrant ssh

h2. Vagrant setup

I will create a puppet forge module ngiger/oddb_org to place everything. I will use the "puppet-librarian":https://github.com/rodjek/librarian-puppet to combine the needed foreign puppet-modules and my own own one.


h1. Discussion

h2. Use of Veewee

"Veewee":https://github.com/jedi4ever/veewee makes installing a complete Linux distribution easy.

The goal is to have a minimal server system, which you can afterwards customize using "puppet":http://docs.puppetlabs.com/puppet/ or chef.

Veewee has two different templates for funtoo. I choose funtoo-latest-x86_64 as it was simpler to bring up (but I lost an hour till a switch using a different iso image and most of the @definition.rb@ of @funtoo-latest-generic_64-stable@. It has only two simple ruby script which configure the whole system. As long as one can start with it, I just don't want to tinker with it.

The funtoo templates are not current. But I found a preconfigured "Vagrant boxes":http://ftp.heanet.ie/mirrors/funtoo/funtoo-current/vagrant/x86-64bit/vagrant-generic_64-funtoo-current-2012-01-26.box

h2. Use of Vagrant

Vagrant is the glue to create definitions for puppet on you development machine and run them easily on a virtualbox VM.

To keep things simple, I use a single fix hostname @oddb_dev@. I use puppet > 3.0 as it makes things a lot more scalabe and easier to configure than 2.7.




Differences between